# SOF-ELKÂ® Configuration File
# (C)2024 Lewes Technology Consulting, LLC
#
# This file contains filters, transforms, and enrichments for Windows Event Log messages sent via the Snare utility

# From: https://prophecyinternational.atlassian.net/wiki/spaces/WADOC/pages/1233224043/Appendix+A+-+Windows+Event+Output+Format
# Snare event record format
# The format of the event record is as follows:
#| Number | Field | Description |
#| :---- | ----: | :----: |
#| 1 | Hostname | The assigned hostname of the machine or the override value entered using the Snare front.
#| 2 | Event Log Type | Fixed value of 'MSWinEventLog'.
#| 3 | Criticality | This is determined by the Alert level given to the objective by the user and is a number between 0 and 4, as detailed in the registry settings in Appendix B.
#| 4 | LogName | This is the Windows Event Log from which the event record was derived. In the above example, the event record was derived from the 'security' event log.
#| 5 | Snare Event Counter | Based on the internal Snare event counter. Rotates at 'MAXDWORD'.
#| 6 | DateTime | This is the date time stamp of the event record.
#| 7 | EventID | This is the Windows Event ID.
#| 8 | SourceName | This is the Windows Event Log from which the event record was derived. In the above example, the event record was derived from the 'security' event log.
#| 9 | UserName | This is the Window's user name.
#| 10 | SIDType | This is the type of SID used. In the above example, it is a 'user' SID, but it may also be a 'computer' or other type of SID.
#| 11 | EventLogType | This can be anyone of 'Success Audit', 'Failure Audit', 'Error', 'Information', or 'Warning'.
#| 12 | ComputerName | This is the Windows computer name.
#| 13 | CategoryString | This is the category of audit event, as detailed by the Windows event logging system.
#| 14 | DataString | This contains the data strings.
#| 15 | ExpandedString | This contains the expanded data strings.
#| 16 | EventSourceId | (optional). Additional data to be included in each event as specified in Event Options settings of the Agent.
#| 17 | MD5 Checksum | (optional). An md5 checksum of the event can optionally be included with each event sent over the network by the Snare for Windows agent. Note that the application that evaluates each record will need to strip the final delimiter, plus the checksum, prior to evaluating the event.

filter {
  # handle snare records
  if [labels][type] == "syslog" and "snare_log" in [tags] {
    csv {
      columns => [ "event_criticality", "event_logsource", "snare_counter", "event_datetime_system_tz", "event_id", "event_source", "username", "event_sidtype", "event_logtype", "hostname", "event_category", "event_fulldata", "event_source_id", "event_md5" ]
      separator => "||"
      skip_empty_columns => "true"
      skip_empty_rows => "true"
      remove_field => [ "message" ]
      convert => {
        "event_criticality" => "integer"
        "event_id" => "integer"
        "event_source_id" => "integer"
        "snare_counter" => "integer"
      }
    }
    # Fri Dec 30 19:01:17 2022
    # this is in SYSTEM LOCAL TIME (ugh) so while it's important to retain, it'll show as UTC in the index by default.  beware!
    if [event_datetime_system_tz] {
      date {
        match => [ "event_datetime_system_tz", "EEE MMM dd HH:mm:ss yyyy"]
        target => "event_datetime_system_tz"
      }
    }
  }
  if [event_source_id] == "N/A" {
    mutate {
      remove_field => [ "event_source_id" ]
    }
  }

  # there is no useful [log][syslog][appname] in a snare message (it contains the hostname), so replace it with the event_source value
  if [event_source] {
    mutate {
      replace => { "[log][syslog][appname]" => "%{event_source}" }
    }
  }

  if [event_fulldata] {
    # replace directory separators so they don't confuse the parser as an escape character
    # the replace syntax is odd because backslashes
    mutate {
      gsub => [ "[event_fulldata]", "[\\]", "/" ]
    }

# TODO: this was previously "^%{DATA:event_data}    %{DATA:event_expanded_data}$" but that seems to have changed with recent test data
#       need to confirm with conforming source data and adjust back as needed
    grok {
      match => { "event_fulldata" => [
        "^%{DATA:event_data}    %{DATA:event_expanded_data}$",
        "^%{DATA:event_data}:  %{DATA:event_expanded_data}$"
        ]
      }
      tag_on_failure => [ "no_data_summary" ]
    }

    if "no_data_summary" in [tags] {
      mutate {
        replace => { "message" => "%{event_fulldata}" }
        remove_tag => [ "no_data_summary" ]
      }

    } else {
      mutate {
        replace => { "message" => "%{event_data}" }
        add_tag => [ "parse_done" ]
      }

#TODO: NEED TO ADD ALL THESE TO THE FIELD LIST DOCUMENT
      mutate {
        gsub => [
          "event_expanded_data", "   +", "||",
          "event_expanded_data", "[^:]  ", "||"
        ]
      }
      kv {
        source => "event_expanded_data"
        target => "kv"
        field_split => "||"
        value_split_pattern => ": +"
      }
      mutate {
        # event_source = Microsoft-Windows-Security-Auditing
        # event_source = Microsoft-Windows-Sysmon
        ## Process Create
        ## Registry Value Set
        ## File Created
        ## Dns query
        ## Driver loaded
        ## Network connection detected
        ## Process terminated
        ## Registry object added or deleted
        ## File creation time changed
        ## Sysmon service state changed
        ## CreateRemoteThread detected
        ## File stream created (TODO: NEED WINLOGBEAT SAMPLE)
        ## A process has exited (TODO: NEED WINLOGBEAT SAMPLE)
# KNOWN FAILED/UNHANDLED PARSES:
## A new process has been created. (need sample)
## Group membership information. (lots of double spaces that screw up the special handling)
## An account was successfully logged on.
## Special privileges assigned to new logon.
        rename => {
          "[kv][Security ID]" => "[user][id]"
          "[kv][Account Name]" => "[user][name]"
          "[kv][Account Domain]" => "[user][domain]"
          "[kv][Logon ID]" => "[winlog][event_data][LogonID]"
          "[kv][Process ID]" => "[winlog][process][pid]"
          "[kv][Process Name]" => "[process][executable]"
          "[kv][Exit Status]" => "[process][exit_code]"

          "[kv][CommandLine]" => "[process][command_line]"
          "[kv][Company]" => "[winlog][event_data][Company]"
          "[kv][Contents]" => "[winlog][event_data][Contents]"
          "[kv][CreationUtcTime]" => "[winlog][event_data][CreationUtcTime]"
          "[kv][CurrentDirectory]" => "[process][working_directory]"
          "[kv][Description]" => "[winlog][event_data][Description]"
          "[kv][DestinationHostname]" => "[destination][domain]"
          "[kv][DestinationIp]" => "[destination][ip]"
          "[kv][DestinationPort]" => "[destination][port]"
          "[kv][Details]" => "[winlog][event_data][Details]"
          "[kv][EventType]" => "[winlog][event_data][EventType]"
          "[kv][FileVersion]" => "[process][pe][file_version]"
          "[kv][IntegrityLevel]" => "[winlog][event_data][IntegrityLevel]"
          "[kv][Image]" => "[process][executable]"
          "[kv][HostUrl]" => "[winlog][event_data][HostUrl]"
          "[kv][LogonGuid]" => "[winlog][event_data][LogonGuid]"
          "[kv][LogonId]" => "[winlog][event_data][LogonId]"
          "[kv][NewThreadId]" => "[winlog][event_data][NewThreadId]"
          "[kv][OriginalFileName]" => "[process][pe][original_file_name]"
          "[kv][ParentCommandLine]" => "[process][parent][command_line]"
          "[kv][ParentImage]" => "[process][parent][executable]"
          "[kv][ParentProcessGuid]" => "[process][parent][entity_id]"
          "[kv][ParentProcessId]" => "[process][parent][pid]"
          "[kv][ParentUser]" => "[winlog][event_data][ParentUser]"
          "[kv][PreviousCreationUtcTime]" => "[winlog][event_data][PreviousCreationUtcTime]"
          "[kv][ProcessGuid]" => "[process][entity_id]"
          "[kv][ProcessId]" => "[process][pid]"
          "[kv][Product]" => "[winlog][event_data][Product]"
          "[kv][Protocol]" => "[network][transport]"
          "[kv][QueryName]" => "[dns][question][name]"
          "[kv][ReferrerUrl]" => "[winlog][event_data][ReferrerUrl]"
          "[kv][RuleName]" => "[rule][name]"
          "[kv][SchemaVersion]" => "[winlog][event_data][SchemaVersion]"
          "[kv][Signature]" => "[winlog][event_data][Signature]"
          "[kv][SignatureValid]" => "[winlog][event_data][SignatureValid]"
          "[kv][Signed]" => "[winlog][event_data][Signed]"
          "[kv][SourceHostname]" => "[source][domain]"
          "[kv][SourceImage]" => "[process][executable]"
          "[kv][SourceIp]" => "[source][ip]"
          "[kv][SourcePort]" => "[source][port]"
          "[kv][SourceProcessGuid]" => "[process][entity_id]"
          "[kv][SourceProcessId]" => "[process][pid]"
          "[kv][SourceUser]" => "[winlog][event_data][SourceUser]"
          "[kv][StartAddress]" => "[winlog][event_data][StartAddress]"
          "[kv][StartFunction]" => "[winlog][event_data][StartFunction]"
          "[kv][StartModule]" => "[winlog][event_data][StartModule]"
          "[kv][State]" => "[winlog][event_data][State]"
          "[kv][TargetFilename]" => "[file][path]"
          "[kv][TargetImage]" => "[winlog][event_data][TargetImage]"
          "[kv][TargetObject]" => "[registry][path]"
          "[kv][TargetProcessGuid]" => "[winlog][event_data][TargetProcessGuid]"
          "[kv][TargetProcessId]" => "[winlog][event_data][TargetProcessId]"
          "[kv][TargetUser]" => "[winlog][event_data][TargetUser]"
          "[kv][TerminalSessionId]" => "[winlog][event_data][TerminalSessionId]"
          "[kv][Version]" => "[winlog][event_data][Version]"
          "[kv][ZoneId]" => "[winlog][event_data][ZoneId]"
        }
#          "[kv][DestinationPortName]" => "[xxxx][xxxxx]"
#          "[kv][SourcePortName]" => "[xxxx][xxxxx]"

#          "[kv][Service]" => "[xxxx][xxxxx]"
#          "[kv][Server]" => "[xxxx][xxxxx]"
#          "[kv][Service Name]" => "[xxxx][xxxxx]"
#          "[kv][Process]" => "[xxxx][xxxxx]"
#          "[kv][Process name]" => "[xxxx][xxxxx]"
#          "[kv][Service Request Information]" => "[xxxx][xxxxx]"
#          "[kv][Privileges]" => "[xxxx][xxxxx]"
#           "[kv][xxxx]" => "[xxxx][xxxxx]"
#           "[kv][xxxx]" => "[xxxx][xxxxx]"
      }
    }

    # if this exists, use it over the syslog datetime since it's in UTC
    if [kv][UtcTime] {
      date {
        match => [ "[kv][UtcTime]", "ISO8601" ]
      }
    }

    if [winlog][event_data][CreationUtcTime] {
      date {
        match => [ "[winlog][event_data][CreationUtcTime]", "ISO8601" ]
        target => "[winlog][event_data][CreationUtcTime]"
      }
    }
    if [winlog][event_data][PreviousCreationUtcTime] {
      date {
        match => [ "[winlog][event_data][PreviousCreationUtcTime]", "ISO8601" ]
        target => "[winlog][event_data][PreviousCreationUtcTime]"
      }
    }

    if [kv][User] {
      # this has been gsubbed \ => / above!
      grok {
        match => { "[kv][User]" => [
          "%{GREEDYDATA:[winlog][user][domain]}/%{USERNAME:[winlog][user][name]}"
          ]
        }
      }
    }

    if [kv][Hashes] {
      kv {
        source => "[kv][Hashes]"
        target => "kvhashes"
        field_split => ","
      }
      if [kvhashes] {
        mutate {
          rename => {
            "[kvhashes][MD5]" => "[process][hash][md5]"
            "[kvhashes][SHA256]" => "[process][hash][sha256]"
            "[kvhashes][IMPHASH]" => "[process][pe][imphash]"
          }
        }
      }
    }

    if [kv][QueryResults] {
      mutate {
        gsub => [ "[kv][QueryResults]", "::ffff:", "" ]
        split => { "[kv][QueryResults]" => ";" }
      }
      mutate {
        rename => {
          "[kv][QueryResults]" => "[dns][answers][data]"
        }
      }
    }

    if [kv][Initiated] {
      if [kv][Initiated] == 'true' {
        mutate {
          add_field => { "[network][direction]" => "egress" }
        }
      } else if [kv][Initated] == 'false' {
        mutate {
          add_field => { "[network][direction]" => "ingress" }
        }
      }
    }

    if [network][transport] {
      translate {
        dictionary_path => "/usr/local/sof-elk/lib/dictionaries/ip_proto_name2int.yaml"
        source => "[network][transport]"
        target => "[network][iana_number]"
      }
    }

    mutate {
      # "event_criticality", "event_logsource", "snare_counter", "event_datetime_system_tz", "username", "event_sidtype", "event_logtype", "event_category", "event_fulldata", "event_source_id", "event_md5"
      rename => {
        "event_id" => "[winlog][event_id]"
        "event_source" => "[event][provider]"
      }
      copy => {
        "hostname" => "[winlog][computer_name]"
        "[event][provider]" => "[winlog][provider_name]"
        "[winlog][event_data][Description]" => "[process][pe][description]"
        "[winlog][event_data][Product]" => "[process][pe][product]"
        "[winlog][event_data][Company]" => "[process][pe][company]"
        "[winlog][user][domain]" => "[user][domain]"
        "[winlog][user][name]" => "[user][name]"
      }
      # add_field => {
      #
      # }
    }

    if [rule][name] == "-" {
      mutate {
        remove_field => [ "[rule][name]" ]
      }
    }
    mutate {
      split => { "[rule][name]" => "," }
    }

    if [user][name] { mutate { merge => { "[related][user]" => "[user][name]" } } }
    if [process][hash][md5] { mutate { merge => { "[related][hash]" => "[process][hash][md5]" } } }
    if [process][hash][sha256] { mutate { merge => { "[related][hash]" => "[process][hash][sha256]" } } }
    if [process][pe][imphash] { mutate { merge => { "[related][hash]" => "[process][pe][imphash]" } } }

## TODO: convert types

### TODO: re-enable this
    # mutate {
    #   remove_field => [ "event_fulldata", "kv", "kvhashes" ]
    # }
    # remove event_expanded_data????
  }
}
