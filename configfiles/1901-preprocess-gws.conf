# SOF-ELKÂ® Configuration File
# (C)2024 Lewes Technology Consulting, LLC
#
# This file parses CSV-formatted Google Workspace logs
# At this time, the only known CSV logs from GWS that will be handled are of the "email log search" type

filter {
  if [type] == "gws" {
    if "csv" in [tags] {

      # gmail log event CSV starts with an ISO8601 timestamp
      if [message] =~ /^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}/ {
        mutate {
          add_tag => [ "gmail_log" ]
        }

      # gmail message CSV starts with the message subject
      } else {
        mutate {
          add_tag => [ "gmail_message" ]
        }
      }

      if "gmail_log" in [tags] {
        ### Gmail logs, in CSV format
        csv {
          separator => ","
          skip_empty_rows => "true"
#          columns => [ "date", "message_id", "subject", "event", "sender_header_address", "sender_envelope", "recipient_envelope", "owner", "delegate", "domain", "attachment_hash", "attachment_name", "attachment_malware_family", "source_ip", "sender_header_name", "link_domain", "spf_domain", "dkim_domain", "traffic_source", "spam_classification", "spam_classification_reason", "geo_location", "oauth_project_id", "target_link_url", "target_attachment_hash", "target_attachment_name", "target_attachment_malware_family", "target_drive_id" ]
          columns => [ "date", "message_id", "subject", "recipient_envelope", "source_ip", "event", "sender_header_address", "sender_envelope", "owner", "link_domain", "dkim_domain", "spf_domain", "traffic_source" ]
          remove_field => "message"
          target => "raw"
        }

      } else if "gmail_message" in [tags] {
        ### Gmail message logs, in CSV format
        csv {
          separator => ","
          skip_empty_rows => "true"
          columns => [ "subject", "message_id", "owner", "date", "sender", "recipient", "label", "attachment_name" ]
          remove_field => "message"
          target => "raw"
        }
      }

      # this seems counterintuitive because it kind of is
      # due to the date detection logic above, the header row will _always_ be parsed as a "gmail_message"
      #   therefore, the first field will always the "subject"
      if [raw][subject] == "Date" or [raw][subject] == "Subject" {
        drop {} # drop the first line that contains the column names
      }
    }
  }
}
